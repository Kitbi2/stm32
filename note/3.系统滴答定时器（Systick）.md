# 系统滴答定时器（Systick）

## 一、什么是定时器

### 1-1：定时器的基本作用和工作原理

1.所谓的定时器本质上都是计数器的作用，根据外部输入的脉冲频率进行计数操作。

2.如果脉冲的频率时1HZ，那么就是以1HZ的频率进行计数操作，换句话来就是1秒钟加一次。

![image-20231202113736633](pic\image-20231202113736633.png)

### 1-2：systick定时器

![image-20231202114622531](pic\image-20231202114622531.png)

1.systick定时器是Contex-M3/M4内核特有的一个定时器（所以对他的描述我们要去查看Contex-M3权威指南）

### 2-1：Systick的时钟源

1.Systick的时钟源有俩个时钟源，第一个是HCLK的时钟源，是72mhz，如下图：

![image-20240325204450076](pic\image-20240325204450076.png)

第二个时钟源是经过八分频过好的Contex的内核时钟源，是9mhz，如下图：

![image-20240325204627139](pic\image-20240325204627139.png)

### 2-2：Systick的工作方式

1.要定时器第一个要知道的就是如何计数，Systick定时器的是一个向下计数的定时器，是什么意思呢？向下计数的意思是是我们设定好一个值，当定时器从某个计数值一点一点向下减少，当减少到0的时候就会重载变成我们设定的计数值。

2.接下来我们要了解一下Systick的主要单元，一个是重装载寄存器，还有一个是计数单元。每一个脉冲来到的时候这个计数单元就会减少一次。而当计数单元减少到0的时候就会从重装载寄存器读取数值到计数单元里面。

3.那么我们就总体来看一下是如何工作的：Systick定时器开启计数，从重载值寄存器读取数值到计数器单元里面进去，然后减少到0的时候从重载值寄存器读取到计数单元，从新开始减少。

4.Systick可以产生溢出中断，每当计数到0的时候就会产生溢出中断。此时就会进入SysTick_Handler这个中断如何函数。

### 2-3：驱动方式

1.这个驱动方式就很简单了，直接就是使能定时器，然后就开始工作了。

## 二、有关寄存器

### 2-1：CTRL控制和状态寄存器

[16]：当systick计数到0的时候该位为1

[2]：选择内部时钟或者外部时钟  HCLK  或者 HCLK/8

[1]：中断使能位

[0]：使能定时器

![image-20231202132324728](pic\image-20231202132324728.png)

### 2-2：LOAD重载值寄存器

1.当定时器计数为0的时候就会把该寄存器的数值从小写入到VAL中

![image-20231202132838801](pic\image-20231202132838801.png)

### 2-3：VAL当前数值寄存器

1.计数寄存器，该寄存器会--，

![image-20231202132844912](pic\image-20231202132844912.png)

## 三、实操

### 3-1：配置systick的中断时间为1ms，每500ms进行LED的反转

#### 3-1-1：思路

1.先配置好定时器：时钟源为外部时钟源，也就是9mhz，重载值为9000，可以每当VAL寄存器减到0的时候刚刚好是1ms

2.使能中断，并且重写中断服务函数

```c
void MySysInit(void)
{
	
	//设置为外部时钟源 9mhz
	SysTick->CTRL |= (0 << 2);
	
	//重载值为9000
	SysTick->LOAD = 9000;
	SysTick->VAL = 0;
	
	//使能定时器
	SysTick->CTRL |= (1 << 0);
	
	//使能中断
	SysTick->CTRL |= (1 << 1);
	
	
}

void SysTick_Handler(void)
{
    //每1ms进入一次中断
	static int i = 0;
	i++;
    
    //i == 500的时候也就是计数到了500ms
	if(i == 500)
	{
		i = 0;
		LED_Red_Toggle();
	}
}
```

#### 



**old > new**：的情况

![image-20231202141219737](pic\image-20231202141219737.png)

**old < new**：的情况

![image-20231202141514970](pic\image-20231202141514970.png)

## 四、状态机，基于状态级的按键消抖

```
SysTick_Config
```